<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Каталог игр - GameForum</title>
    
    <!-- Стили -->
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="/static/css/catalog.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
</head>
<body class="catalog-page">
    <!-- Хедер -->
    <div id="header"></div>
    
    <!-- Основной контент -->
    <main>
        <!-- Заголовок страницы -->
        <section class="page-header">
            <h1 class="page-title">Каталог игр</h1>
            <p class="page-subtitle">Ищите игры по жанрам, обсуждайте с сообществом, делитесь опытом и находите единомышленников</p>
            <div class="catalog-admin-actions" id="catalogAdminActions" style="display: none;">
                <button type="button" class="catalog-admin-btn" id="addGameBtn">
                    <i class="fas fa-plus"></i>
                    Добавить игру
                </button>
            </div>
        </section>
        
        <!-- Поиск и фильтры -->
        <section class="search-filter">
            <div class="search-box">
                <i class="fas fa-search search-icon"></i>
                <input type="text" class="search-input" placeholder="Поиск игр..." id="gameSearch">
            </div>
            
            <div class="filter-tags">
                <span class="filter-tag active" data-filter="all">Все игры</span>
                <span class="filter-tag" data-filter="shooter">Шутеры</span>
                <span class="filter-tag" data-filter="rpg">RPG</span>
                <span class="filter-tag" data-filter="strategy">Стратегии</span>
                <span class="filter-tag" data-filter="adventure">Приключения</span>
                <span class="filter-tag" data-filter="sports">Спортивные</span>
                <span class="filter-tag" data-filter="simulator">Симуляторы</span>
            </div>
        </section>
        
        <!-- Сетка игр -->
        <section class="games-container">
            <div class="games-grid" id="gamesGrid">
                <!-- Игры будут загружены через JavaScript -->
            </div>
            
            <div class="empty-state" id="noGames" style="display: none;">
                <i class="fas fa-gamepad"></i>
                <h3>Игры не найдены</h3>
                <p>Попробуйте изменить параметры поиска</p>
            </div>
        </section>

        <div class="topic-modal" id="gameModal">
            <div class="topic-modal-overlay" id="gameModalOverlay"></div>
            <div class="topic-modal-content glass-panel">
                <div class="topic-modal-header">
                    <h3><i class="fas fa-gamepad"></i> Добавить игру</h3>
                    <button type="button" class="topic-modal-close" id="closeGameModal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <form id="createGameForm" class="topic-modal-form">
                    <label for="newGameSlug">Slug</label>
                    <input type="text" id="newGameSlug" maxlength="80" required placeholder="Например: valorant">

                    <label for="newGameTitle">Название</label>
                    <input type="text" id="newGameTitle" maxlength="120" required placeholder="Например: Valorant">

                    <label for="newGameDescription">Описание</label>
                    <textarea id="newGameDescription" maxlength="5000" placeholder="Краткое описание игры"></textarea>

                    <label for="newGameCoverUrl">Cover URL</label>
                    <input type="text" id="newGameCoverUrl" maxlength="500" placeholder="/img/covers/cs2.jpg или https://...">

                    <div class="topic-modal-actions">
                        <button type="button" class="topic-modal-cancel" id="cancelGameCreate">Отмена</button>
                        <button type="submit" class="topic-modal-submit" id="submitGameCreate">
                            <i class="fas fa-plus"></i>
                            Создать игру
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </main>
    
    <!-- Футер -->
    <div id="footer"></div>
    
    <!-- Скрипты -->
    <script src="/static/js/script.js"></script>
        <script>
        let allGames = [];
        let currentViewer = { authenticated: false, username: '', role: 'GUEST' };
        const validFilters = new Set(['all', 'shooter', 'rpg', 'strategy', 'adventure', 'sports', 'simulator']);

        const genreNames = {
            shooter: 'Шутер',
            rpg: 'RPG',
            strategy: 'Стратегия',
            adventure: 'Приключение',
            sports: 'Спорт',
            simulator: 'Симулятор'
        };

        function inferGenre(title = '', description = '') {
            const text = `${title} ${description}`.toLowerCase();
            if (text.includes('counter-strike') || text.includes('shooter') || text.includes('шутер')) return 'shooter';
            if (text.includes('dota') || text.includes('moba') || text.includes('league of legends') || text.includes('strategy') || text.includes('стратег')) return 'strategy';
            if (text.includes('fifa') || text.includes('sport') || text.includes('футбол')) return 'sports';
            if (text.includes('simulator') || text.includes('flight') || text.includes('симулятор')) return 'simulator';
            if (text.includes('adventure') || text.includes('приключ')) return 'adventure';
            return 'rpg';
        }

        function escapeHtml(value) {
            return String(value)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        function getLocalCoverFallback(slug = '', title = '') {
            const key = `${slug} ${title}`.toLowerCase();
            if (key.includes('dota')) return '/img/covers/dota2.jpg';
            if (key.includes('counter-strike') || key.includes('cs2')) return '/img/covers/cs2.jpg';
            if (key.includes('league of legends') || key.includes('lol')) return '/img/covers/lol.jpg';
            return '/img/covers/cs2.jpg';
        }

        function resolveCoverUrls(item) {
            const fallback = getLocalCoverFallback(item?.slug || '', item?.title || '');
            const coverUrl = typeof item?.coverUrl === 'string' ? item.coverUrl.trim() : '';

            if (!coverUrl) {
                return { image: fallback, fallback };
            }

            // В сид-данных могли остаться demo-ссылки example.com, для них сразу используем локальный cover.
            if (/^https?:\/\/example\.com\//i.test(coverUrl)) {
                return { image: fallback, fallback };
            }

            return { image: coverUrl, fallback };
        }

        function generateStars(rating) {
            let stars = '';
            const normalized = Number.isFinite(rating) ? Math.max(0, Math.min(10, rating)) : 0;
            const starsOutOfFive = normalized / 2;
            const fullStars = Math.floor(starsOutOfFive);
            const hasHalfStar = starsOutOfFive % 1 >= 0.5;

            for (let i = 1; i <= 5; i++) {
                if (i <= fullStars) {
                    stars += '<i class="fas fa-star"></i>';
                } else if (i === fullStars + 1 && hasHalfStar) {
                    stars += '<i class="fas fa-star-half-alt"></i>';
                } else {
                    stars += '<i class="far fa-star"></i>';
                }
            }
            return stars;
        }

        async function fetchTopicCount(gameId) {
            try {
                const response = await fetch(`/api/forum/games/${gameId}/topics`);
                if (!response.ok) return 0;
                const topics = await response.json();
                return Array.isArray(topics) ? topics.length : 0;
            } catch (error) {
                console.warn('Failed to fetch topics for game', gameId, error);
                return 0;
            }
        }

        async function loadGamesFromApi() {
            const response = await fetch('/api/games?page=0&size=100');
            if (!response.ok) {
                throw new Error(`Failed to load games: ${response.status}`);
            }

            const payload = await response.json();
            const items = Array.isArray(payload?.items) ? payload.items : [];
            const topicCounts = await Promise.all(items.map(item => fetchTopicCount(item.id)));

            return items.map((item, index) => {
                const covers = resolveCoverUrls(item);
                return {
                    id: item.id,
                    slug: item.slug || '',
                    title: item.title || `Game #${item.id}`,
                    description: item.description || 'Описание временно отсутствует',
                    image: covers.image,
                    fallbackImage: covers.fallback,
                    rating: Number(item.ratingAvg || 0),
                    genre: inferGenre(item.title, item.description),
                    topics: topicCounts[index] || 0
                };
            });
        }

        async function loadCurrentViewer() {
            const token = localStorage.getItem('token');
            if (!token) {
                currentViewer = { authenticated: false, username: '', role: 'GUEST' };
                return;
            }

            try {
                const response = await fetch('/api/me', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) {
                    throw new Error('Unauthorized');
                }
                const payload = await response.json();
                if (!payload?.authenticated) {
                    throw new Error('Unauthorized');
                }

                currentViewer = {
                    authenticated: true,
                    username: payload.username || '',
                    role: String(payload.role || 'USER').toUpperCase()
                };
            } catch (_) {
                currentViewer = { authenticated: false, username: '', role: 'GUEST' };
            }
        }

        function canManageGames() {
            return currentViewer.role === 'ADMIN' || currentViewer.role === 'PUBLISHER';
        }

        function canDeleteGames() {
            return currentViewer.role === 'ADMIN';
        }

        function renderGames(gamesToRender) {
            const gamesGrid = document.getElementById('gamesGrid');
            const noGames = document.getElementById('noGames');

            gamesGrid.innerHTML = '';

            if (!gamesToRender.length) {
                noGames.style.display = 'block';
                return;
            }

            noGames.style.display = 'none';

            gamesToRender.forEach(game => {
                const safeTitle = escapeHtml(game.title);
                const safeDescription = escapeHtml(game.description);
                const safeGenre = escapeHtml(genreNames[game.genre] || game.genre || 'RPG');
                const imageUrl = escapeHtml(game.image);
                const fallbackImageUrl = escapeHtml(game.fallbackImage || '/img/covers/cs2.jpg');
                const gameSlug = escapeHtml(game.slug || '');
                const topics = Number(game.topics || 0);
                const rating = Number(game.rating || 0);
                const deleteButton = canDeleteGames()
                    ? `
                        <button type="button" class="game-delete-btn" data-game-slug="${gameSlug}" data-game-title="${safeTitle}">
                            <i class="fas fa-trash-alt"></i>
                            Удалить
                        </button>
                    `
                    : '';

                const gameCard = document.createElement('div');
                gameCard.className = 'game-card';
                gameCard.dataset.id = String(game.id);
                gameCard.dataset.genre = game.genre;

                gameCard.innerHTML = `
                    <div class="game-media-wrap">
                        <img src="${imageUrl}" alt="${safeTitle}" class="game-image" onerror="this.onerror=null;this.src='${fallbackImageUrl}'">
                        ${deleteButton}
                    </div>
                    <div class="game-info">
                        <span class="game-genre">${safeGenre}</span>
                        <h3 class="game-title">${safeTitle}</h3>
                        <p class="game-description">${safeDescription}</p>
                        <div class="game-meta">
                            <div class="game-rating">
                                <div class="rating-stars">
                                    ${generateStars(rating)}
                                </div>
                                <span class="rating-value">${rating.toFixed(1)}</span>
                            </div>
                            <div class="game-topics">
                                <i class="fas fa-comments"></i>
                                ${topics.toLocaleString('ru-RU')} тем
                            </div>
                        </div>
                    </div>
                `;

                gameCard.addEventListener('click', () => {
                    openGameTopics(game.id, game.title);
                });

                gameCard.querySelector('.game-delete-btn')?.addEventListener('click', async (event) => {
                    event.preventDefault();
                    event.stopPropagation();
                    await deleteGameAsAdmin(game.slug, game.title);
                });

                gamesGrid.appendChild(gameCard);
            });
        }

        function openGameTopics(gameId, gameTitle) {
            sessionStorage.setItem('currentGameId', String(gameId));
            sessionStorage.setItem('currentGameTitle', gameTitle);
            window.location.href = `/game-topics.html?game=${gameId}`;
        }

        function filterGames() {
            const searchTerm = document.getElementById('gameSearch').value.toLowerCase();
            const activeFilter = document.querySelector('.filter-tag.active')?.dataset.filter || 'all';

            let filtered = allGames;

            if (searchTerm) {
                filtered = filtered.filter(game =>
                    game.title.toLowerCase().includes(searchTerm) ||
                    game.description.toLowerCase().includes(searchTerm)
                );
            }

            if (activeFilter !== 'all') {
                filtered = filtered.filter(game => game.genre === activeFilter);
            }

            renderGames(filtered);
        }

        function applyFilterTag(filterValue) {
            const normalized = validFilters.has(filterValue) ? filterValue : 'all';
            const tags = document.querySelectorAll('.filter-tag');
            tags.forEach(tag => {
                tag.classList.toggle('active', tag.dataset.filter === normalized);
            });
        }

        function getInitialFilterFromUrl() {
            const params = new URLSearchParams(window.location.search);
            const raw = (params.get('category') || params.get('filter') || 'all').toLowerCase().trim();
            return validFilters.has(raw) ? raw : 'all';
        }

        function openGameModal() {
            const modal = document.getElementById('gameModal');
            if (!modal) return;
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function closeGameModal() {
            const modal = document.getElementById('gameModal');
            if (!modal) return;
            modal.classList.remove('show');
            document.body.style.overflow = '';
            document.getElementById('createGameForm')?.reset();
        }

        function setupCatalogAdminActions() {
            const actions = document.getElementById('catalogAdminActions');
            const addGameBtn = document.getElementById('addGameBtn');
            const createGameForm = document.getElementById('createGameForm');

            if (canManageGames()) {
                actions?.style.removeProperty('display');
            } else if (actions) {
                actions.style.display = 'none';
            }

            addGameBtn?.addEventListener('click', () => {
                if (!canManageGames()) return;
                openGameModal();
            });

            document.getElementById('closeGameModal')?.addEventListener('click', closeGameModal);
            document.getElementById('cancelGameCreate')?.addEventListener('click', closeGameModal);
            document.getElementById('gameModalOverlay')?.addEventListener('click', closeGameModal);
            createGameForm?.addEventListener('submit', handleCreateGame);
        }

        function normalizeSlug(value) {
            return String(value || '')
                .trim()
                .toLowerCase()
                .replace(/[^a-z0-9-]+/g, '-')
                .replace(/^-+|-+$/g, '');
        }

        async function handleCreateGame(event) {
            event.preventDefault();
            if (!canManageGames()) {
                alert('Добавлять игры могут только издатель или администратор');
                return;
            }

            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/auth/login.html';
                return;
            }

            const submitBtn = document.getElementById('submitGameCreate');
            const originalHtml = submitBtn?.innerHTML || '';
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Создание...';
            }

            const slug = normalizeSlug(document.getElementById('newGameSlug')?.value);
            const title = (document.getElementById('newGameTitle')?.value || '').trim();
            const description = (document.getElementById('newGameDescription')?.value || '').trim();
            const coverUrl = (document.getElementById('newGameCoverUrl')?.value || '').trim();

            if (!slug || slug.length < 2) {
                alert('Введите корректный slug (минимум 2 символа)');
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalHtml;
                }
                return;
            }

            if (!title || title.length < 2) {
                alert('Введите название игры (минимум 2 символа)');
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalHtml;
                }
                return;
            }

            try {
                const response = await fetch('/api/publisher/games', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ slug, title, description, coverUrl })
                });

                if (!response.ok) {
                    let message = 'Не удалось создать игру';
                    try {
                        const payload = await response.json();
                        message = payload.message || message;
                    } catch (_) {
                        // ignore parse errors
                    }
                    throw new Error(message);
                }

                closeGameModal();
                await initializeCatalog();
                if (typeof window.showNotification === 'function') {
                    window.showNotification('Игра добавлена', 'success');
                }
            } catch (error) {
                alert(error.message || 'Ошибка создания игры');
            } finally {
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalHtml;
                }
            }
        }

        async function deleteGameAsAdmin(slug, title) {
            if (!canDeleteGames()) {
                alert('Удалять игры может только администратор');
                return;
            }
            if (!slug) {
                alert('Невозможно удалить игру без slug');
                return;
            }

            const shouldDelete = confirm(`Удалить игру "${title}"?`);
            if (!shouldDelete) {
                return;
            }

            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/auth/login.html';
                return;
            }

            try {
                const response = await fetch(`/api/publisher/games/${encodeURIComponent(slug)}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    let message = 'Не удалось удалить игру';
                    try {
                        const payload = await response.json();
                        message = payload.message || message;
                    } catch (_) {
                        // ignore parse errors
                    }
                    throw new Error(message);
                }

                await initializeCatalog();
                if (typeof window.showNotification === 'function') {
                    window.showNotification('Игра удалена', 'success');
                }
            } catch (error) {
                alert(error.message || 'Ошибка удаления игры');
            }
        }

        async function initializeCatalog() {
            try {
                allGames = await loadGamesFromApi();
            } catch (error) {
                console.error('Ошибка загрузки каталога из БД:', error);
                allGames = [];
            }
            filterGames();
        }

        document.addEventListener('DOMContentLoaded', async function() {
            await loadCurrentViewer();
            document.getElementById('gameSearch').addEventListener('input', filterGames);

            document.querySelectorAll('.filter-tag').forEach(tag => {
                tag.addEventListener('click', function() {
                    applyFilterTag(this.dataset.filter || 'all');
                    filterGames();
                });
            });

            applyFilterTag(getInitialFilterFromUrl());
            setupCatalogAdminActions();
            loadHeaderAndFooter();
            await initializeCatalog();
        });

        function loadHeaderAndFooter() {
            fetch('/fragments/header.html')
                .then(response => {
                    if (!response.ok) throw new Error('Не удалось загрузить хедер');
                    return response.text();
                })
                .then(html => {
                    document.getElementById('header').innerHTML = html;
                    if (typeof initializeHeader === 'function') {
                        initializeHeader();
                    }
                })
                .catch(error => {
                    console.error('Ошибка загрузки хедера:', error);
                    document.getElementById('header').innerHTML = '<div style="color: white; padding: 20px; text-align: center;">Ошибка загрузки хедера</div>';
                });

            fetch('/fragments/footer.html')
                .then(response => {
                    if (!response.ok) throw new Error('Не удалось загрузить футер');
                    return response.text();
                })
                .then(html => {
                    document.getElementById('footer').innerHTML = html;
                    if (typeof initializeFooter === 'function') {
                        initializeFooter();
                    }
                })
                .catch(error => {
                    console.error('Ошибка загрузки футера:', error);
                    document.getElementById('footer').innerHTML = '<div style="color: white; padding: 20px; text-align: center;">Ошибка загрузки футера</div>';
                });
        }
    </script>
</body>
</html>

