<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Каталог игр - GameForum</title>
    
    <!-- Стили -->
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="/static/css/catalog.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
</head>
<body class="catalog-page">
    <!-- Хедер -->
    <div id="header"></div>
    
    <!-- Основной контент -->
    <main>
        <!-- Заголовок страницы -->
        <section class="page-header">
            <h1 class="page-title">Каталог игр</h1>
            <p class="page-subtitle">Ищите игры по жанрам, обсуждайте с сообществом, делитесь опытом и находите единомышленников</p>
        </section>
        
        <!-- Поиск и фильтры -->
        <section class="search-filter">
            <div class="search-box">
                <i class="fas fa-search search-icon"></i>
                <input type="text" class="search-input" placeholder="Поиск игр..." id="gameSearch">
            </div>
            
            <div class="filter-tags">
                <span class="filter-tag active" data-filter="all">Все игры</span>
                <span class="filter-tag" data-filter="shooter">Шутеры</span>
                <span class="filter-tag" data-filter="rpg">RPG</span>
                <span class="filter-tag" data-filter="strategy">Стратегии</span>
                <span class="filter-tag" data-filter="adventure">Приключения</span>
                <span class="filter-tag" data-filter="sports">Спортивные</span>
                <span class="filter-tag" data-filter="simulator">Симуляторы</span>
            </div>
        </section>
        
        <!-- Сетка игр -->
        <section class="games-container">
            <div class="games-grid" id="gamesGrid">
                <!-- Игры будут загружены через JavaScript -->
            </div>
            
            <div class="empty-state" id="noGames" style="display: none;">
                <i class="fas fa-gamepad"></i>
                <h3>Игры не найдены</h3>
                <p>Попробуйте изменить параметры поиска</p>
            </div>
        </section>
    </main>
    
    <!-- Футер -->
    <div id="footer"></div>
    
    <!-- Скрипты -->
    <script src="/static/js/script.js"></script>
        <script>
        let allGames = [];

        const genreNames = {
            shooter: 'Шутер',
            rpg: 'RPG',
            strategy: 'Стратегия',
            adventure: 'Приключение',
            sports: 'Спорт',
            simulator: 'Симулятор'
        };

        function inferGenre(title = '', description = '') {
            const text = `${title} ${description}`.toLowerCase();
            if (text.includes('counter-strike') || text.includes('shooter') || text.includes('шутер')) return 'shooter';
            if (text.includes('dota') || text.includes('moba') || text.includes('league of legends') || text.includes('strategy') || text.includes('стратег')) return 'strategy';
            if (text.includes('fifa') || text.includes('sport') || text.includes('футбол')) return 'sports';
            if (text.includes('simulator') || text.includes('flight') || text.includes('симулятор')) return 'simulator';
            if (text.includes('adventure') || text.includes('приключ')) return 'adventure';
            return 'rpg';
        }

        function escapeHtml(value) {
            return String(value)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        function generateStars(rating) {
            let stars = '';
            const normalized = Number.isFinite(rating) ? Math.max(0, Math.min(10, rating)) : 0;
            const starsOutOfFive = normalized / 2;
            const fullStars = Math.floor(starsOutOfFive);
            const hasHalfStar = starsOutOfFive % 1 >= 0.5;

            for (let i = 1; i <= 5; i++) {
                if (i <= fullStars) {
                    stars += '<i class="fas fa-star"></i>';
                } else if (i === fullStars + 1 && hasHalfStar) {
                    stars += '<i class="fas fa-star-half-alt"></i>';
                } else {
                    stars += '<i class="far fa-star"></i>';
                }
            }
            return stars;
        }

        async function fetchTopicCount(gameId) {
            try {
                const response = await fetch(`/api/forum/games/${gameId}/topics`);
                if (!response.ok) return 0;
                const topics = await response.json();
                return Array.isArray(topics) ? topics.length : 0;
            } catch (error) {
                console.warn('Failed to fetch topics for game', gameId, error);
                return 0;
            }
        }

        async function loadGamesFromApi() {
            const response = await fetch('/api/games?page=0&size=100');
            if (!response.ok) {
                throw new Error(`Failed to load games: ${response.status}`);
            }

            const payload = await response.json();
            const items = Array.isArray(payload?.items) ? payload.items : [];
            const topicCounts = await Promise.all(items.map(item => fetchTopicCount(item.id)));

            return items.map((item, index) => ({
                id: item.id,
                title: item.title || `Game #${item.id}`,
                description: item.description || 'Описание временно отсутствует',
                image: item.coverUrl || '/img/covers/cs2.jpg',
                rating: Number(item.ratingAvg || 0),
                genre: inferGenre(item.title, item.description),
                topics: topicCounts[index] || 0
            }));
        }

        function renderGames(gamesToRender) {
            const gamesGrid = document.getElementById('gamesGrid');
            const noGames = document.getElementById('noGames');

            gamesGrid.innerHTML = '';

            if (!gamesToRender.length) {
                noGames.style.display = 'block';
                return;
            }

            noGames.style.display = 'none';

            gamesToRender.forEach(game => {
                const safeTitle = escapeHtml(game.title);
                const safeDescription = escapeHtml(game.description);
                const safeGenre = escapeHtml(genreNames[game.genre] || game.genre || 'RPG');
                const imageUrl = escapeHtml(game.image);
                const topics = Number(game.topics || 0);
                const rating = Number(game.rating || 0);

                const gameCard = document.createElement('div');
                gameCard.className = 'game-card';
                gameCard.dataset.id = String(game.id);
                gameCard.dataset.genre = game.genre;

                gameCard.innerHTML = `
                    <img src="${imageUrl}" alt="${safeTitle}" class="game-image" onerror="this.src='/img/covers/cs2.jpg'">
                    <div class="game-info">
                        <span class="game-genre">${safeGenre}</span>
                        <h3 class="game-title">${safeTitle}</h3>
                        <p class="game-description">${safeDescription}</p>
                        <div class="game-meta">
                            <div class="game-rating">
                                <div class="rating-stars">
                                    ${generateStars(rating)}
                                </div>
                                <span class="rating-value">${rating.toFixed(1)}</span>
                            </div>
                            <div class="game-topics">
                                <i class="fas fa-comments"></i>
                                ${topics.toLocaleString('ru-RU')} тем
                            </div>
                        </div>
                    </div>
                `;

                gameCard.addEventListener('click', () => {
                    openGameTopics(game.id, game.title);
                });

                gamesGrid.appendChild(gameCard);
            });
        }

        function openGameTopics(gameId, gameTitle) {
            sessionStorage.setItem('currentGameId', String(gameId));
            sessionStorage.setItem('currentGameTitle', gameTitle);
            window.location.href = `/game-topics.html?game=${gameId}`;
        }

        function filterGames() {
            const searchTerm = document.getElementById('gameSearch').value.toLowerCase();
            const activeFilter = document.querySelector('.filter-tag.active')?.dataset.filter || 'all';

            let filtered = allGames;

            if (searchTerm) {
                filtered = filtered.filter(game =>
                    game.title.toLowerCase().includes(searchTerm) ||
                    game.description.toLowerCase().includes(searchTerm)
                );
            }

            if (activeFilter !== 'all') {
                filtered = filtered.filter(game => game.genre === activeFilter);
            }

            renderGames(filtered);
        }

        async function initializeCatalog() {
            try {
                allGames = await loadGamesFromApi();
            } catch (error) {
                console.error('Ошибка загрузки каталога из БД:', error);
                allGames = [];
            }
            filterGames();
        }

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('gameSearch').addEventListener('input', filterGames);

            document.querySelectorAll('.filter-tag').forEach(tag => {
                tag.addEventListener('click', function() {
                    document.querySelectorAll('.filter-tag').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    filterGames();
                });
            });

            loadHeaderAndFooter();
            initializeCatalog();
        });

        function loadHeaderAndFooter() {
            fetch('/fragments/header.html')
                .then(response => {
                    if (!response.ok) throw new Error('Не удалось загрузить хедер');
                    return response.text();
                })
                .then(html => {
                    document.getElementById('header').innerHTML = html;
                    if (typeof initializeHeader === 'function') {
                        initializeHeader();
                    }
                })
                .catch(error => {
                    console.error('Ошибка загрузки хедера:', error);
                    document.getElementById('header').innerHTML = '<div style="color: white; padding: 20px; text-align: center;">Ошибка загрузки хедера</div>';
                });

            fetch('/fragments/footer.html')
                .then(response => {
                    if (!response.ok) throw new Error('Не удалось загрузить футер');
                    return response.text();
                })
                .then(html => {
                    document.getElementById('footer').innerHTML = html;
                    if (typeof initializeFooter === 'function') {
                        initializeFooter();
                    }
                })
                .catch(error => {
                    console.error('Ошибка загрузки футера:', error);
                    document.getElementById('footer').innerHTML = '<div style="color: white; padding: 20px; text-align: center;">Ошибка загрузки футера</div>';
                });
        }
    </script>
</body>
</html>

