<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Профиль пользователя - GameForum</title>

    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="/static/css/profile.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="profile-page">
    <div id="header"></div>

    <main class="profile-main">
        <div class="container">
            <section class="profile-hero glass-panel">
                <div class="profile-avatar-wrap glass-card">
                    <div class="profile-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <span class="profile-rank">Rank #284</span>
                </div>

                <div class="profile-headline">
                    <h1 id="profileName">Игрок</h1>
                    <p id="profileRole">Участник сообщества GameForum</p>
                    <div class="profile-tags">
                        <span class="profile-tag"><i class="fas fa-shield-alt"></i> Проверенный аккаунт</span>
                        <span class="profile-tag"><i class="fas fa-fire"></i> Активен сегодня</span>
                    </div>
                </div>

                <div class="profile-actions">
                    <button type="button" class="glass-btn action-btn" id="editProfileBtn">
                        <i class="fas fa-user-edit"></i>
                        Редактировать
                    </button>
                    <button type="button" class="glass-btn action-btn secondary" id="accountSettingsBtn">
                        <i class="fas fa-cog"></i>
                        Настройки
                    </button>
                </div>
            </section>

            <section class="profile-grid">
                <article class="profile-card glass-card">
                    <h2><i class="fas fa-id-badge"></i> Обо мне</h2>
                    <p id="profileBio">Заполните информацию о себе в форме редактирования профиля.</p>
                    <ul class="profile-list">
                        <li><i class="fas fa-calendar-alt"></i> На форуме с: <span id="profileMemberSince">-</span></li>
                        <li><i class="fas fa-map-marker-alt"></i> Город: <span id="profileCity">Не указан</span></li>
                        <li><i class="fas fa-clock"></i> Последний вход: Сегодня, 19:24</li>
                    </ul>
                </article>

                <article class="profile-card glass-card">
                    <h2><i class="fas fa-chart-line"></i> Статистика</h2>
                    <div class="stats-grid">
                        <div class="stat-box">
                            <span class="stat-value">128</span>
                            <span class="stat-label">Тем создано</span>
                        </div>
                        <div class="stat-box">
                            <span class="stat-value">742</span>
                            <span class="stat-label">Комментариев</span>
                        </div>
                        <div class="stat-box">
                            <span class="stat-value">96</span>
                            <span class="stat-label">Подписок</span>
                        </div>
                        <div class="stat-box">
                            <span class="stat-value">4.8</span>
                            <span class="stat-label">Репутация</span>
                        </div>
                    </div>
                </article>

                <article class="profile-card glass-card full">
                    <h2><i class="fas fa-trophy"></i> Любимые игры</h2>
                    <div class="favorite-games" id="favoriteGamesList">
                        <div class="game-pill">
                            <i class="fas fa-gamepad"></i>
                            Любимые игры не указаны
                        </div>
                    </div>
                </article>
            </section>

            <section class="profile-grid profile-edit-grid">
                <article class="profile-card glass-card full form-card" id="editProfileCard">
                    <h2><i class="fas fa-user-edit"></i> Редактирование профиля</h2>
                    <form id="editProfileForm" class="profile-form">
                        <label for="editBio">Обо мне</label>
                        <textarea id="editBio" maxlength="1200" placeholder="Расскажите о себе"></textarea>

                        <label for="editCity">Город</label>
                        <input type="text" id="editCity" maxlength="80" placeholder="Например: Кишинёв">

                        <label for="editFavoriteGames">Любимые игры (через запятую)</label>
                        <input type="text" id="editFavoriteGames" maxlength="500" placeholder="Cyberpunk 2077, Dota 2, Elden Ring">

                        <div class="form-actions-row">
                            <button type="submit" class="glass-btn action-btn" id="saveProfileBtn">
                                <i class="fas fa-save"></i>
                                Сохранить профиль
                            </button>
                        </div>
                    </form>
                </article>

                <article class="profile-card glass-card full form-card" id="accountSettingsCard" style="display: none;">
                    <h2><i class="fas fa-cog"></i> Настройки аккаунта</h2>
                    <form id="accountSettingsForm" class="profile-form">
                        <label for="settingsEmail">Email</label>
                        <input type="email" id="settingsEmail" placeholder="example@mail.com">

                        <label for="settingsCurrentPassword">Текущий пароль</label>
                        <input type="password" id="settingsCurrentPassword" placeholder="Введите текущий пароль">

                        <label for="settingsNewPassword">Новый пароль</label>
                        <input type="password" id="settingsNewPassword" placeholder="Не менее 8 символов">

                        <div class="settings-checkboxes">
                            <label class="setting-check">
                                <input type="checkbox" id="settingsEmailNotifications">
                                <span>Получать email-уведомления</span>
                            </label>
                            <label class="setting-check">
                                <input type="checkbox" id="settingsPublicProfile">
                                <span>Публичный профиль</span>
                            </label>
                        </div>

                        <div class="form-actions-row">
                            <button type="submit" class="glass-btn action-btn secondary" id="saveSettingsBtn">
                                <i class="fas fa-save"></i>
                                Сохранить настройки
                            </button>
                        </div>
                    </form>
                </article>
            </section>
        </div>
    </main>

    <div id="footer"></div>

    <script src="/static/js/script.js"></script>
    <script>
        let currentProfile = null;

        document.addEventListener('DOMContentLoaded', async function() {
            await Promise.all([
                loadFragment('header', '/fragments/header.html', true),
                loadFragment('footer', '/fragments/footer.html', false)
            ]);
            setupProfileActions();
            await hydrateProfileData();
        });

        async function loadFragment(containerId, path, isHeader) {
            const container = document.getElementById(containerId);

            try {
                const response = await fetch(path);
                if (!response.ok) {
                    throw new Error('Ошибка загрузки фрагмента');
                }

                container.innerHTML = await response.text();

                if (isHeader && typeof initializeHeader === 'function') {
                    initializeHeader();
                }

                if (!isHeader && typeof initializeFooter === 'function') {
                    initializeFooter();
                }
            } catch (error) {
                container.innerHTML = '<div class="fragment-error">Не удалось загрузить блок страницы</div>';
                console.error(error);
            }
        }

        function setupProfileActions() {
            document.getElementById('editProfileBtn')?.addEventListener('click', () => toggleProfilePanels('edit'));
            document.getElementById('accountSettingsBtn')?.addEventListener('click', () => toggleProfilePanels('settings'));

            document.getElementById('editProfileForm')?.addEventListener('submit', saveProfileChanges);
            document.getElementById('accountSettingsForm')?.addEventListener('submit', saveAccountSettings);
        }

        function toggleProfilePanels(mode) {
            const editCard = document.getElementById('editProfileCard');
            const settingsCard = document.getElementById('accountSettingsCard');
            const editBtn = document.getElementById('editProfileBtn');
            const settingsBtn = document.getElementById('accountSettingsBtn');

            const editMode = mode === 'edit';
            editCard.style.display = editMode ? 'block' : 'none';
            settingsCard.style.display = editMode ? 'none' : 'block';

            editBtn.classList.toggle('active', editMode);
            settingsBtn.classList.toggle('active', !editMode);
        }

        async function hydrateProfileData() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/auth/login.html';
                return;
            }

            try {
                const response = await fetch('/api/me/profile', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });

                if (!response.ok) {
                    localStorage.removeItem('token');
                    localStorage.removeItem('isLoggedIn');
                    window.location.href = '/auth/login.html';
                    return;
                }
                const data = await response.json();
                currentProfile = data;
                localStorage.setItem('isLoggedIn', 'true');
                if (data.username) {
                    localStorage.setItem('username', data.username);
                }
                applyProfileData(data);
            } catch (error) {
                console.error(error);
                notify('Не удалось загрузить профиль', 'error');
            }
        }

        function applyProfileData(profile) {
            const safeProfile = profile || {};
            document.getElementById('profileName').textContent = safeProfile.username || 'Игрок';
            document.getElementById('profileRole').textContent = safeProfile.role ? `Роль: ${safeProfile.role}` : 'Участник сообщества GameForum';
            document.getElementById('profileBio').textContent = safeProfile.bio || 'Заполните информацию о себе в форме редактирования профиля.';
            document.getElementById('profileCity').textContent = safeProfile.city || 'Не указан';
            document.getElementById('profileMemberSince').textContent = safeProfile.memberSince || '-';

            document.getElementById('editBio').value = safeProfile.bio || '';
            document.getElementById('editCity').value = safeProfile.city === 'Не указан' ? '' : (safeProfile.city || '');
            document.getElementById('editFavoriteGames').value = (safeProfile.favoriteGames || []).join(', ');

            document.getElementById('settingsEmail').value = safeProfile.email || '';
            document.getElementById('settingsEmailNotifications').checked = Boolean(safeProfile.emailNotifications);
            document.getElementById('settingsPublicProfile').checked = Boolean(safeProfile.publicProfile);
            document.getElementById('settingsCurrentPassword').value = '';
            document.getElementById('settingsNewPassword').value = '';

            renderFavoriteGames(safeProfile.favoriteGames || []);
            toggleProfilePanels('edit');
        }

        function renderFavoriteGames(games) {
            const container = document.getElementById('favoriteGamesList');
            const normalized = (games || []).filter(Boolean);

            if (normalized.length === 0) {
                container.innerHTML = `
                    <div class="game-pill">
                        <i class="fas fa-gamepad"></i>
                        Любимые игры не указаны
                    </div>
                `;
                return;
            }

            container.innerHTML = normalized.map((game) => `
                <div class="game-pill">
                    <i class="fas fa-gamepad"></i>
                    ${escapeHtml(game)}
                </div>
            `).join('');
        }

        async function saveProfileChanges(event) {
            event.preventDefault();
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/auth/login.html';
                return;
            }

            const submitBtn = document.getElementById('saveProfileBtn');
            const original = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Сохраняем...';

            const payload = {
                bio: document.getElementById('editBio').value.trim(),
                city: document.getElementById('editCity').value.trim(),
                favoriteGames: document.getElementById('editFavoriteGames').value
                    .split(',')
                    .map(item => item.trim())
                    .filter(Boolean)
            };

            try {
                const response = await fetch('/api/me/profile', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    let message = 'Не удалось сохранить профиль';
                    try {
                        const data = await response.json();
                        message = data.message || message;
                    } catch (_) {
                        // ignore json parse errors
                    }
                    throw new Error(message);
                }

                const updated = await response.json();
                currentProfile = updated;
                applyProfileData(updated);
                notify('Профиль обновлён', 'success');
            } catch (error) {
                notify(error.message || 'Ошибка сохранения профиля', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = original;
            }
        }

        async function saveAccountSettings(event) {
            event.preventDefault();
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/auth/login.html';
                return;
            }

            const submitBtn = document.getElementById('saveSettingsBtn');
            const original = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Сохраняем...';

            const payload = {
                email: document.getElementById('settingsEmail').value.trim(),
                currentPassword: document.getElementById('settingsCurrentPassword').value,
                newPassword: document.getElementById('settingsNewPassword').value,
                emailNotifications: document.getElementById('settingsEmailNotifications').checked,
                publicProfile: document.getElementById('settingsPublicProfile').checked
            };

            try {
                const response = await fetch('/api/me/settings', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    let message = 'Не удалось сохранить настройки';
                    try {
                        const data = await response.json();
                        message = data.message || message;
                    } catch (_) {
                        // ignore json parse errors
                    }
                    throw new Error(message);
                }

                const updated = await response.json();
                currentProfile = updated;
                applyProfileData(updated);
                toggleProfilePanels('settings');
                notify('Настройки аккаунта обновлены', 'success');
            } catch (error) {
                notify(error.message || 'Ошибка сохранения настроек', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = original;
            }
        }

        function notify(message, type = 'info') {
            if (typeof window.showNotification === 'function') {
                window.showNotification(message, type);
                return;
            }
            alert(message);
        }

        function escapeHtml(value) {
            return String(value)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }
    </script>
</body>
</html>
