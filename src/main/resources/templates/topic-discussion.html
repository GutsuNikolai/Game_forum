<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Обсуждение - GameForum</title>
    
    <!-- Стили -->
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="/static/css/topic-discussion.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    
</head>
<body class="discussion-page">
    <!-- Хедер -->
    <div id="header"></div>
    
    <!-- Основной контент -->
    <main>
        <!-- Заголовок темы -->
        <section class="discussion-header">
            <div class="topic-header">
                <div class="breadcrumb">
                    <a href="/catalog.html">Каталог игр</a>
                    <span class="separator">/</span>
                    <a href="/game-topics.html" id="backToTopics">Темы игры</a>
                    <span class="separator">/</span>
                    <span id="currentTopic">Обсуждение</span>
                </div>
                
                <h1 class="topic-title-main" id="topicTitleMain">Загрузка темы...</h1>
                <div class="topic-meta-main">
                    <span><i class="fas fa-user"></i> <span id="topicAuthor">Автор</span></span>
                    <span><i class="fas fa-clock"></i> <span id="topicDate">Дата</span></span>
                    <span><i class="fas fa-comment"></i> <span id="repliesCount">0</span> ответов</span>
                    <span><i class="fas fa-eye"></i> <span id="viewsCount">0</span> просмотров</span>
                </div>
            </div>
        </section>
        
        <!-- Сообщения -->
        <section class="discussion-container">
            <div class="messages-list" id="messagesList">
                <!-- Сообщения будут загружены через JavaScript -->
            </div>
            
            <div class="empty-messages" id="noMessages" style="display: none;">
                <i class="fas fa-comments"></i>
                <h3>Сообщений пока нет</h3>
                <p>Будьте первым, кто оставит сообщение в этой теме!</p>
            </div>
            
            <!-- Форма ответа -->
            <div class="reply-form-container" id="replyFormContainer">
                <h3>Ваш ответ</h3>
                <form class="reply-form" id="replyForm">
                    <div class="reply-context" id="replyContextBanner">
                        <span id="replyContextText">Ответ на сообщение</span>
                        <button type="button" id="clearReplyContext">Сбросить</button>
                    </div>
                    <div class="reply-toolbar" id="replyToolbar">
                        <button type="button" class="editor-tool" data-command="bold" title="Жирный">
                            <i class="fas fa-bold"></i>
                        </button>
                        <button type="button" class="editor-tool" data-command="italic" title="Курсив">
                            <i class="fas fa-italic"></i>
                        </button>
                        <button type="button" class="editor-tool" data-command="underline" title="Подчеркнутый">
                            <i class="fas fa-underline"></i>
                        </button>
                        <button type="button" class="editor-tool" data-command="insertUnorderedList" title="Маркированный список">
                            <i class="fas fa-list-ul"></i>
                        </button>
                        <button type="button" class="editor-tool" id="insertQuoteBtn" title="Цитата">
                            <i class="fas fa-quote-right"></i>
                        </button>
                        <button type="button" class="editor-tool" id="insertLinkBtn" title="Ссылка">
                            <i class="fas fa-link"></i>
                        </button>
                        <button type="button" class="editor-tool" id="clearFormatBtn" title="Очистить форматирование">
                            <i class="fas fa-eraser"></i>
                        </button>
                    </div>

                    <div class="reply-editor" id="replyTextEditor" contenteditable="true" data-placeholder="Напишите ваш ответ здесь..."></div>
                    <textarea id="replyText" hidden></textarea>

                    <div class="reply-attachments">
                        <button type="button" class="attach-image-btn" id="attachImageBtn">
                            <i class="fas fa-image"></i>
                            Upload image
                        </button>
                        <input type="file" id="attachImageInput" accept="image/*" multiple hidden>
                        <span class="attach-hint">Up to 5 images (jpg/png/webp/gif, max 5 MB)</span>
                    </div>

                    <div class="reply-image-preview" id="replyImagePreview"></div>

                    <div class="form-actions">
                        <button type="button" class="cancel-reply" id="cancelReply">Отмена</button>
                        <button type="submit" class="submit-reply" id="submitReply">
                            <i class="fas fa-paper-plane"></i>
                            Отправить ответ
                        </button>
                    </div>
                </form>
            </div>
        </section>
    </main>
    
    <!-- Футер -->
    <div id="footer"></div>
    
    <!-- Скрипты -->
    <script src="/static/js/script.js"></script>
    <script>

        // Данные для темы
        const topicData = {
            101: {
                title: "Оптимизация игры на слабых ПК",
                author: "GamerPro",
                date: "15 марта 2024",
                replies: 245,
                views: 12500,
                description: "Делимся советами по настройкам графики для комфортной игры на слабых компьютерах."
            },
            102: {
                title: "Сюжетные линии и концовки",
                author: "StoryLover",
                date: "10 марта 2024",
                replies: 189,
                views: 9800,
                description: "Обсуждение всех возможных сюжетных развитий и концовок игры."
            },
            // ... другие темы
        };
        
        // Резервные сообщения (используются только если API недоступен)
        const fallbackTopicMessages = {
            101: [
                {
                    id: 1,
                    author: "GamerPro",
                    avatarColor: "#00b4db",
                    date: "15 марта 2024, 14:30",
                    content: "Привет всем! Собрал здесь лучшие настройки для игры на слабых ПК. У меня GTX 1050 Ti и i5-7400, играю на средних настройках с 45-60 FPS. Главное - выключить ray tracing и поставить DLSS на качество.",
                    likes: 42,
                    replies: 8
                },
                {
                    id: 2,
                    author: "LowSpecGamer",
                    avatarColor: "#ff6b6b",
                    date: "15 марта 2024, 15:45",
                    content: "Спасибо за советы! У меня еще слабее конфиг: GTX 960 и i3-8100. После ваших настроек получил стабильные 30 FPS на низких. Еще советую понизить разрешение до 1600x900 - помогает сильно.",
                    likes: 28,
                    replies: 3
                },
                {
                    id: 3,
                    author: "TechWizard",
                    avatarColor: "#6bcf7f",
                    date: "15 марта 2024, 17:20",
                    content: "Не забывайте про настройки в NVIDIA Control Panel! Для этой игры особенно важны: Threaded Optimization - On, Power Management - Prefer Maximum Performance. +15% производительности гарантировано.",
                    likes: 56,
                    replies: 12
                }
            ],
            102: [
                {
                    id: 1,
                    author: "StoryLover",
                    avatarColor: "#9c27b0",
                    date: "10 марта 2024, 11:15",
                    content: "Прошел игру уже 3 раза и нашел 4 разные концовки. Самая эпичная, на мой взгляд, - когда главный герой улетает с Панам. Какие концовки нашли вы?",
                    likes: 89,
                    replies: 45
                },
                {
                    id: 2,
                    author: "ChoiceMaster",
                    avatarColor: "#ff9800",
                    date: "10 марта 2024, 13:40",
                    content: "Интересно, что многие решения влияют не только на концовку, но и на доступные миссии в середине игры. Особенно выборы в отношениях с Джуди.",
                    likes: 67,
                    replies: 23
                }
            ]
        };
        let currentViewer = { authenticated: false, username: '', role: 'GUEST' };
        let currentTopicId = 0;
        let replyContext = { parentMessageId: null, quotedMessageId: null, mode: null, author: '' };
        let editingMessageId = null;
        let editingOriginalImages = [];
        let latestMessages = [];

        function sanitizeMessageHtml(rawHtml) {
            if (!rawHtml) return '';
            const temp = document.createElement('div');
            temp.innerHTML = rawHtml;
            const allowed = new Set(['B', 'STRONG', 'I', 'EM', 'U', 'S', 'BR', 'DIV', 'P', 'UL', 'OL', 'LI', 'BLOCKQUOTE', 'A']);

            temp.querySelectorAll('*').forEach(node => {
                if (!allowed.has(node.tagName)) {
                    node.replaceWith(document.createTextNode(node.textContent || ''));
                    return;
                }

                Array.from(node.attributes).forEach(attr => {
                    if (node.tagName === 'A' && attr.name === 'href') {
                        const href = node.getAttribute('href') || '';
                        if (!/^https?:\/\//i.test(href)) {
                            node.removeAttribute('href');
                        } else {
                            node.setAttribute('target', '_blank');
                            node.setAttribute('rel', 'noopener noreferrer');
                        }
                    } else {
                        node.removeAttribute(attr.name);
                    }
                });
            });

            return temp.innerHTML.trim();
        }

        function normalizeImageUrl(url) {
            if (typeof url !== 'string') {
                return null;
            }

            const normalized = url.trim();
            const isRemote = /^https?:\/\/[^\s"'<>]+$/i.test(normalized);
            const isLocal = /^\/[^\s"'<>]+$/.test(normalized);
            return (isRemote || isLocal) ? normalized : null;
        }

        async function loadCurrentViewer() {
            const token = localStorage.getItem('token');
            if (!token) {
                currentViewer = { authenticated: false, username: '', role: 'GUEST' };
                return;
            }

            try {
                const response = await fetch('/api/me', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) {
                    throw new Error('Unauthorized');
                }
                const payload = await response.json();
                if (!payload?.authenticated) {
                    throw new Error('Unauthorized');
                }

                currentViewer = {
                    authenticated: true,
                    username: payload.username || '',
                    role: String(payload.role || 'USER').toUpperCase()
                };
            } catch (_) {
                currentViewer = { authenticated: false, username: '', role: 'GUEST' };
            }
        }

        function canModerateMessages() {
            return currentViewer.role === 'ADMIN';
        }

        function canEditMessage(message) {
            if (canModerateMessages()) {
                return true;
            }
            return currentViewer.authenticated && String(currentViewer.username || '') === String(message.author || '');
        }
        
        // Функция загрузки данных темы
        async function loadTopicData() {
            const urlParams = new URLSearchParams(window.location.search);
            const topicId = Number(urlParams.get('topic') || sessionStorage.getItem('currentTopicId') || 101);
            currentTopicId = topicId;
            const fallbackTopicTitle = sessionStorage.getItem('currentTopicTitle') || `Тема #${topicId}`;
            let topic = topicData[topicId] || {
                title: fallbackTopicTitle,
                author: 'Участник форума',
                date: new Date().toLocaleDateString('ru-RU'),
                replies: 0,
                views: 0,
                description: 'Обсуждение темы игрового сообщества'
            };

            try {
                const response = await fetch(`/api/forum/topics/${topicId}`);
                if (response.ok) {
                    const topicFromApi = await response.json();
                    topic = {
                        title: topicFromApi.title || topic.title,
                        author: topicFromApi.author || topic.author,
                        date: topicFromApi.lastActivity || topic.date,
                        replies: topicFromApi.replies ?? topic.replies,
                        views: topicFromApi.views ?? topic.views,
                        description: topicFromApi.description || topic.description
                    };

                    if (topicFromApi.gameId) {
                        sessionStorage.setItem('currentGameId', String(topicFromApi.gameId));
                    }
                }
            } catch (error) {
                console.warn('Не удалось загрузить тему через API, используется резервный режим', error);
            }
            
            // Обновляем заголовок страницы
            document.title = `${topic.title} - Обсуждение - GameForum`;
            
            // Обновляем данные темы
            document.getElementById('topicTitleMain').textContent = topic.title;
            document.getElementById('topicAuthor').textContent = topic.author;
            document.getElementById('topicDate').textContent = topic.date;
            document.getElementById('repliesCount').textContent = topic.replies;
            document.getElementById('viewsCount').textContent = topic.views.toLocaleString();
            document.getElementById('currentTopic').textContent = topic.title;
            
            // Обновляем ссылку назад
            document.getElementById('backToTopics').href = `/game-topics.html?game=${sessionStorage.getItem('currentGameId') || 1}`;
            
            // Загружаем сообщения
            await loadTopicMessages(topicId);
        }
        
        // Функция загрузки сообщений
        async function loadTopicMessages(topicId) {
            let messages = [];
            const messagesList = document.getElementById('messagesList');
            const noMessages = document.getElementById('noMessages');

            try {
                const response = await fetch(`/api/forum/topics/${topicId}/messages`);
                if (!response.ok) {
                    throw new Error('Не удалось загрузить сообщения темы');
                }
                messages = await response.json();
            } catch (error) {
                console.warn('API форума недоступен, загружаем резервные сообщения', error);
                messages = fallbackTopicMessages[topicId] || [];
            }
            latestMessages = Array.isArray(messages) ? messages : [];

            messagesList.innerHTML = '';
            document.getElementById('repliesCount').textContent = String(messages.length);

            if (messages.length === 0) {
                noMessages.style.display = 'block';
                document.getElementById('replyFormContainer').style.display = 'block';
                return;
            }

            noMessages.style.display = 'none';

            messages.forEach(message => {
                const messageCard = document.createElement('div');
                messageCard.className = 'message-card';
                messageCard.dataset.id = message.id;

                // Генерация цвета аватара если нет в данных
                const avatarColor = message.avatarColor || getRandomColor();
                const safeContent = sanitizeMessageHtml(message.content || '');
                const safeAuthor = escapeHtml(message.author || 'Участник форума');
                const safeDate = escapeHtml(message.date || 'только что');
                const isEdited = Boolean(message.edited);
                const editedSuffix = isEdited ? ' (изменено)' : '';
                const likes = Number(message.likes ?? 0);
                const dislikes = Number(message.dislikes ?? 0);
                const isLiked = hasLikedMessage(topicId, message.id);
                const isDisliked = hasDislikedMessage(topicId, message.id);
                const canEdit = canEditMessage(message);
                const canDelete = canModerateMessages();
                const quotedAuthor = escapeHtml(message.quotedAuthor || 'Участник');
                const quotedPreview = escapeHtml(message.quotedPreview || 'Цитата недоступна');
                const quoteBlock = message.quotedMessageId
                    ? `<div class="message-quote-ref"><strong>${quotedAuthor}:</strong> ${quotedPreview}</div>`
                    : '';
                const messageImages = (message.imageUrls || [])
                    .map(normalizeImageUrl)
                    .filter(Boolean)
                    .map(url => `
                    <a href="${url}" target="_blank" rel="noopener noreferrer" class="message-image-link">
                        <img src="${url}" alt="Прикрепленное фото" class="message-image-item">
                    </a>
                `).join('');

                const imagesBlock = messageImages
                    ? `<div class="message-images">${messageImages}</div>`
                    : '';

                messageCard.innerHTML = `
                    <div class="message-header">
                        <div class="user-avatar" style="background: ${avatarColor};">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="user-info">
                            <h4>${safeAuthor}</h4>
                            <p>${safeDate}${editedSuffix}</p>
                        </div>
                    </div>
                    ${quoteBlock}
                    <div class="message-content">
                        ${safeContent}
                    </div>
                    ${imagesBlock}
                    <div class="message-actions">
                        <div class="message-action ${isLiked ? 'is-liked' : ''}" data-action="like" data-message-id="${message.id}">
                            <i class="fas fa-thumbs-up"></i>
                            <span>${likes}</span>
                        </div>
                        <div class="message-action ${isDisliked ? 'is-liked' : ''}" data-action="dislike" data-message-id="${message.id}">
                            <i class="fas fa-thumbs-down"></i>
                            <span>${dislikes}</span>
                        </div>
                        <div class="message-action" data-action="reply">
                            <i class="fas fa-reply"></i>
                            <span>Ответить</span>
                        </div>
                        <div class="message-action" data-action="quote">
                            <i class="fas fa-quote-right"></i>
                            <span>Цитировать</span>
                        </div>
                        ${canEdit ? `
                            <div class="message-action" data-action="edit">
                                <i class="fas fa-pen"></i>
                                <span>Редактировать</span>
                            </div>
                        ` : ''}
                        ${canDelete ? `
                            <div class="message-action danger" data-action="delete">
                                <i class="fas fa-trash-alt"></i>
                                <span>Удалить</span>
                            </div>
                        ` : ''}
                    </div>
                `;

                messagesList.appendChild(messageCard);
            });
        }
        
        // Функция для генерации случайного цвета
        function getRandomColor() {
            const colors = [
                '#00b4db', '#0083b0', '#6bcf7f', '#ff6b6b', 
                '#ffd93d', '#9c27b0', '#ff9800', '#3f51b5'
            ];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        function escapeHtml(value) {
            return String(value)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        function likedMessagesStorageKey(topicId) {
            return `likedTopicMessages:${topicId}`;
        }

        function dislikedMessagesStorageKey(topicId) {
            return `dislikedTopicMessages:${topicId}`;
        }

        function getLikedMessages(topicId) {
            try {
                const raw = sessionStorage.getItem(likedMessagesStorageKey(topicId));
                const parsed = raw ? JSON.parse(raw) : [];
                return new Set(Array.isArray(parsed) ? parsed.map(Number) : []);
            } catch (_) {
                return new Set();
            }
        }

        function hasLikedMessage(topicId, messageId) {
            const liked = getLikedMessages(topicId);
            return liked.has(Number(messageId));
        }

        function getDislikedMessages(topicId) {
            try {
                const raw = sessionStorage.getItem(dislikedMessagesStorageKey(topicId));
                const parsed = raw ? JSON.parse(raw) : [];
                return new Set(Array.isArray(parsed) ? parsed.map(Number) : []);
            } catch (_) {
                return new Set();
            }
        }

        function hasDislikedMessage(topicId, messageId) {
            const disliked = getDislikedMessages(topicId);
            return disliked.has(Number(messageId));
        }

        function markMessageLiked(topicId, messageId) {
            const liked = getLikedMessages(topicId);
            liked.add(Number(messageId));
            sessionStorage.setItem(likedMessagesStorageKey(topicId), JSON.stringify(Array.from(liked)));
        }

        function markMessageDisliked(topicId, messageId) {
            const disliked = getDislikedMessages(topicId);
            disliked.add(Number(messageId));
            sessionStorage.setItem(dislikedMessagesStorageKey(topicId), JSON.stringify(Array.from(disliked)));
        }

        function bindMessageActionHandlers(topicId) {
            const messagesList = document.getElementById('messagesList');
            if (!messagesList || messagesList.dataset.actionsBound === 'true') {
                return;
            }

            messagesList.addEventListener('click', async function(event) {
                const actionElement = event.target.closest('.message-action');
                if (!actionElement) return;

                const action = actionElement.dataset.action;
                const messageCard = actionElement.closest('.message-card');
                const messageId = Number(actionElement.dataset.messageId || messageCard?.dataset.id || 0);
                if (!messageId) return;
                const message = latestMessages.find(item => Number(item.id) === messageId) || null;

                if (action === 'reply') {
                    if (!message) return;
                    startReplyToMessage(message, false);
                    return;
                }

                if (action === 'quote') {
                    if (!message) return;
                    startReplyToMessage(message, true);
                    return;
                }

                if (action === 'edit') {
                    if (!message) return;
                    startEditingMessage(message);
                    return;
                }

                if (action === 'delete') {
                    if (!message) return;
                    await deleteMessageAsAdmin(topicId, message);
                    return;
                }

                if (action !== 'like' && action !== 'dislike') {
                    return;
                }

                const token = localStorage.getItem('token');
                if (!token) {
                    alert('Войдите в аккаунт, чтобы ставить лайки');
                    window.location.href = '/auth/login.html';
                    return;
                }

                if (action === 'like' && hasLikedMessage(topicId, messageId)) {
                    return;
                }
                if (action === 'dislike' && hasDislikedMessage(topicId, messageId)) {
                    return;
                }

                actionElement.classList.add('is-loading');
                try {
                    const endpoint = action === 'dislike' ? 'dislike' : 'like';
                    const response = await fetch(`/api/forum/messages/${messageId}/${endpoint}`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (!response.ok) {
                        throw new Error('Не удалось поставить лайк');
                    }

                    const updated = await response.json();
                    const likesValue = Number(updated?.likes ?? NaN);
                    const dislikesValue = Number(updated?.dislikes ?? NaN);
                    const likesSpan = actionElement.querySelector('span');
                    if (!likesSpan) {
                        return;
                    }

                    if (action === 'like') {
                        if (Number.isFinite(likesValue)) {
                            likesSpan.textContent = String(likesValue);
                        } else {
                            likesSpan.textContent = String(Number(likesSpan.textContent || 0) + 1);
                        }
                        markMessageLiked(topicId, messageId);
                    } else if (likesSpan) {
                        if (Number.isFinite(dislikesValue)) {
                            likesSpan.textContent = String(dislikesValue);
                        } else {
                            likesSpan.textContent = String(Number(likesSpan.textContent || 0) + 1);
                        }
                        markMessageDisliked(topicId, messageId);
                    }

                    actionElement.classList.add('is-liked');
                } catch (error) {
                    alert(error.message || 'Ошибка при установке реакции');
                } finally {
                    actionElement.classList.remove('is-loading');
                }
            });

            messagesList.dataset.actionsBound = 'true';
        }

        function getComposerTitleElement() {
            return document.querySelector('#replyFormContainer h3');
        }

        function updateComposerContextBanner() {
            const banner = document.getElementById('replyContextBanner');
            const text = document.getElementById('replyContextText');
            const title = getComposerTitleElement();
            if (!banner || !text) {
                return;
            }

            if (editingMessageId) {
                text.textContent = `Редактирование сообщения #${editingMessageId}`;
                banner.classList.add('show');
                if (title) {
                    title.textContent = 'Редактирование сообщения';
                }
                return;
            }

            const hasReplyContext = Boolean(replyContext.parentMessageId || replyContext.quotedMessageId);
            if (hasReplyContext) {
                const actionText = replyContext.mode === 'quote' ? 'Цитирование' : 'Ответ';
                const authorText = replyContext.author ? ` для ${replyContext.author}` : '';
                text.textContent = `${actionText}${authorText}`;
                banner.classList.add('show');
                if (title) {
                    title.textContent = 'Ваш ответ';
                }
                return;
            }

            banner.classList.remove('show');
            if (title) {
                title.textContent = 'Ваш ответ';
            }
        }

        function resetComposerContext() {
            replyContext = { parentMessageId: null, quotedMessageId: null, mode: null, author: '' };
            editingMessageId = null;
            editingOriginalImages = [];
            updateComposerContextBanner();
        }

        function focusReplyComposer() {
            const editor = document.getElementById('replyTextEditor');
            editor?.focus();
            document.getElementById('replyFormContainer')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function getPlainMessageText(rawHtml) {
            const temp = document.createElement('div');
            temp.innerHTML = sanitizeMessageHtml(rawHtml || '');
            return (temp.textContent || '').replace(/\s+/g, ' ').trim();
        }

        function prependQuoteToEditor(author, content) {
            const editor = document.getElementById('replyTextEditor');
            if (!editor) {
                return;
            }

            const plain = getPlainMessageText(content);
            const quoteText = plain.length > 240 ? `${plain.slice(0, 237)}...` : plain;
            const quoteHtml = `<blockquote><strong>${escapeHtml(author)}:</strong> ${escapeHtml(quoteText)}</blockquote><p><br></p>`;
            editor.innerHTML = `${quoteHtml}${editor.innerHTML}`;
        }

        function startReplyToMessage(message, includeQuote) {
            if (!currentViewer.authenticated) {
                alert('Войдите в аккаунт, чтобы отвечать в теме');
                window.location.href = '/auth/login.html';
                return;
            }

            editingMessageId = null;
            editingOriginalImages = [];
            replyContext = {
                parentMessageId: Number(message.id || 0) || null,
                quotedMessageId: includeQuote ? (Number(message.id || 0) || null) : null,
                mode: includeQuote ? 'quote' : 'reply',
                author: message.author || ''
            };

            if (includeQuote) {
                prependQuoteToEditor(message.author || 'Участник', message.content || '');
            } else {
                const editor = document.getElementById('replyTextEditor');
                if (editor && editor.innerHTML.trim() === '') {
                    editor.innerHTML = `<p>@${escapeHtml(message.author || 'user')}, </p>`;
                }
            }

            updateComposerContextBanner();
            focusReplyComposer();
        }

        function startEditingMessage(message) {
            if (!canEditMessage(message)) {
                alert('Вы можете редактировать только свои сообщения');
                return;
            }

            editingMessageId = Number(message.id || 0) || null;
            editingOriginalImages = (message.imageUrls || [])
                .map(normalizeImageUrl)
                .filter(Boolean);
            replyContext = { parentMessageId: null, quotedMessageId: null, mode: null, author: '' };

            const editor = document.getElementById('replyTextEditor');
            if (editor) {
                editor.innerHTML = sanitizeMessageHtml(message.content || '');
            }

            updateComposerContextBanner();
            focusReplyComposer();
        }

        async function deleteMessageAsAdmin(topicId, message) {
            if (!canModerateMessages()) {
                alert('Удалять сообщения может только администратор');
                return;
            }

            const messageId = Number(message?.id || 0);
            if (!messageId) {
                return;
            }

            const shouldDelete = confirm('Удалить это сообщение?');
            if (!shouldDelete) {
                return;
            }

            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/auth/login.html';
                return;
            }

            try {
                const response = await fetch(`/api/forum/messages/${messageId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    let messageText = 'Не удалось удалить сообщение';
                    try {
                        const payload = await response.json();
                        messageText = payload.message || messageText;
                    } catch (_) {
                        // ignore parse errors
                    }
                    throw new Error(messageText);
                }

                await loadTopicMessages(topicId);
                if (typeof window.showNotification === 'function') {
                    window.showNotification('Сообщение удалено', 'success');
                }
            } catch (error) {
                alert(error.message || 'Ошибка удаления сообщения');
            }
        }
        
        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', async function() {
            await loadCurrentViewer();
            await loadTopicData();
            
            // Проверяем авторизацию для формы ответа
            const isLoggedIn = currentViewer.authenticated;
            const replyEditor = document.getElementById('replyTextEditor');
            const replyText = document.getElementById('replyText');
            const submitReply = document.getElementById('submitReply');
            const attachImageBtn = document.getElementById('attachImageBtn');
            const attachImageInput = document.getElementById('attachImageInput');
            const replyImagePreview = document.getElementById('replyImagePreview');
            const activeTopicId = Number(
                new URLSearchParams(window.location.search).get('topic')
                || sessionStorage.getItem('currentTopicId')
                || 101
            );
            const MAX_IMAGES = 5;
            const attachedImages = [];

            initializeReplyEditor();
            initializeImageAttachments();
            bindMessageActionHandlers(activeTopicId);
            updateComposerContextBanner();
            document.getElementById('clearReplyContext')?.addEventListener('click', function() {
                resetComposerContext();
            });
            
            if (!isLoggedIn) {
                replyEditor.setAttribute('contenteditable', 'false');
                replyEditor.dataset.placeholder = 'Войдите в аккаунт, чтобы оставлять ответы';
                replyEditor.classList.add('is-disabled');
                submitReply.disabled = true;
                submitReply.innerHTML = '<i class="fas fa-lock"></i> Войдите для ответа';
                document.querySelectorAll('.editor-tool').forEach(button => {
                    button.disabled = true;
                    button.classList.add('is-disabled');
                });
                attachImageBtn.disabled = true;
                attachImageBtn.classList.add('is-disabled');
                attachImageInput.disabled = true;
            }
            
            // Обработчик формы ответа
            const replyForm = document.getElementById('replyForm');
            if (replyForm) {
                replyForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    if (!isLoggedIn) {
                        alert('Войдите в аккаунт, чтобы оставлять ответы');
                        return;
                    }
                    
                    const replyHtml = sanitizeReplyHtml(replyEditor.innerHTML.trim());
                    const replyPlainText = extractPlainText(replyHtml);
                    replyText.value = replyHtml;
                    
                    if (!replyPlainText && attachedImages.length === 0 && editingOriginalImages.length === 0) {
                        alert('Введите текст ответа или прикрепите фото');
                        return;
                    }
                    
                    const submitBtn = document.getElementById('submitReply');
                    const originalText = submitBtn.innerHTML;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Отправка...';
                    submitBtn.disabled = true;

                    try {
                        const token = localStorage.getItem('token');
                        const uploadedImages = attachedImages.map(image => image.url);
                        const imageUrlsToSend = editingMessageId
                            ? Array.from(new Set([...editingOriginalImages, ...uploadedImages]))
                            : uploadedImages;
                        const endpoint = editingMessageId
                            ? `/api/forum/messages/${editingMessageId}`
                            : `/api/forum/topics/${activeTopicId}/messages`;
                        const method = editingMessageId ? 'PATCH' : 'POST';

                        const response = await fetch(endpoint, {
                            method,
                            headers: {
                                'Content-Type': 'application/json',
                                ...(token ? { 'Authorization': `Bearer ${token}` } : {})
                            },
                            body: JSON.stringify({
                                content: replyHtml,
                                imageUrls: imageUrlsToSend,
                                parentMessageId: editingMessageId ? null : replyContext.parentMessageId,
                                quotedMessageId: editingMessageId ? null : replyContext.quotedMessageId
                            })
                        });

                        if (!response.ok) {
                            let errorMessage = 'Не удалось отправить сообщение';
                            try {
                                const errorData = await response.json();
                                errorMessage = errorData.message || errorMessage;
                            } catch (_) {
                                // noop
                            }
                            throw new Error(errorMessage);
                        }

                        replyEditor.innerHTML = '';
                        replyText.value = '';
                        clearAttachedImages();
                        resetComposerContext();
                        await loadTopicMessages(activeTopicId);
                    } catch (error) {
                        alert(error.message || 'Ошибка при отправке сообщения');
                    } finally {
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                    }
                });
            }
            
            // Кнопка отмены
            document.getElementById('cancelReply')?.addEventListener('click', function() {
                replyEditor.innerHTML = '';
                replyText.value = '';
                clearAttachedImages();
                resetComposerContext();
            });

            function initializeReplyEditor() {
                const toolbarButtons = document.querySelectorAll('.editor-tool[data-command]');
                toolbarButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        if (!isLoggedIn) return;
                        const command = this.dataset.command;
                        replyEditor.focus();
                        document.execCommand(command, false);
                        syncEditorState();
                    });
                });

                document.getElementById('insertQuoteBtn')?.addEventListener('click', function() {
                    if (!isLoggedIn) return;
                    replyEditor.focus();
                    document.execCommand('formatBlock', false, 'blockquote');
                    syncEditorState();
                });

                document.getElementById('insertLinkBtn')?.addEventListener('click', function() {
                    if (!isLoggedIn) return;
                    const rawUrl = prompt('Введите ссылку (https://...)');
                    if (!rawUrl) return;

                    const url = /^https?:\/\//i.test(rawUrl) ? rawUrl : `https://${rawUrl}`;
                    replyEditor.focus();
                    document.execCommand('createLink', false, url);
                    syncEditorState();
                });

                document.getElementById('clearFormatBtn')?.addEventListener('click', function() {
                    if (!isLoggedIn) return;
                    replyEditor.focus();
                    document.execCommand('removeFormat', false);
                    document.execCommand('formatBlock', false, 'div');
                    syncEditorState();
                });

                replyEditor.addEventListener('input', syncEditorState);
                replyEditor.addEventListener('blur', syncEditorState);
            }

            function initializeImageAttachments() {
                attachImageBtn?.addEventListener('click', function() {
                    if (!isLoggedIn) return;
                    attachImageInput?.click();
                });

                attachImageInput?.addEventListener('change', async function(event) {
                    if (!isLoggedIn) return;

                    const files = Array.from(event.target.files || []);
                    if (files.length === 0) return;

                    if (attachedImages.length >= MAX_IMAGES) {
                        alert(`You can attach up to ${MAX_IMAGES} images.`);
                        event.target.value = '';
                        return;
                    }

                    const remainingSlots = MAX_IMAGES - attachedImages.length;
                    const filesToUpload = files.slice(0, remainingSlots);
                    const token = localStorage.getItem('token');
                    if (!token) {
                        alert('Please sign in to upload images.');
                        event.target.value = '';
                        return;
                    }

                    const originalButtonHtml = attachImageBtn.innerHTML;
                    attachImageBtn.disabled = true;
                    attachImageBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';

                    try {
                        for (const file of filesToUpload) {
                            if (!file.type || !file.type.startsWith('image/')) {
                                continue;
                            }

                            const formData = new FormData();
                            formData.append('file', file);

                            const response = await fetch('/api/forum/uploads/image', {
                                method: 'POST',
                                headers: {
                                    'Authorization': `Bearer ${token}`
                                },
                                body: formData
                            });

                            if (!response.ok) {
                                throw new Error('Failed to upload image');
                            }

                            const payload = await response.json();
                            const imageUrl = normalizeImageUrl(payload?.url || '');
                            if (!imageUrl) {
                                continue;
                            }
                            if (attachedImages.some(image => image.url === imageUrl)) {
                                continue;
                            }

                            attachedImages.push({
                                id: `${Date.now()}-${Math.random().toString(36).slice(2)}`,
                                url: imageUrl
                            });
                        }

                        renderImagePreview();
                    } catch (error) {
                        alert(error.message || 'Image upload failed');
                    } finally {
                        attachImageBtn.disabled = false;
                        attachImageBtn.innerHTML = originalButtonHtml;
                        event.target.value = '';
                    }
                });

                replyImagePreview?.addEventListener('click', function(event) {
                    const removeButton = event.target.closest('[data-remove-image-id]');
                    if (!removeButton) return;

                    const id = removeButton.dataset.removeImageId;
                    const index = attachedImages.findIndex(image => image.id === id);
                    if (index === -1) return;

                    attachedImages.splice(index, 1);
                    renderImagePreview();
                });
            }

            function renderImagePreview() {
                if (attachedImages.length === 0) {
                    replyImagePreview.innerHTML = '';
                    return;
                }

                replyImagePreview.innerHTML = attachedImages.map(image => `
                    <div class="image-preview-card">
                        <a href="${image.url}" target="_blank" rel="noopener noreferrer">
                            <img src="${image.url}" alt="Прикрепленное фото">
                        </a>
                        <button type="button" class="remove-image-btn" data-remove-image-id="${image.id}">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `).join('');
            }

            function clearAttachedImages() {
                attachedImages.length = 0;
                renderImagePreview();
            }

            function syncEditorState() {
                if (replyEditor.innerHTML === '<br>') {
                    replyEditor.innerHTML = '';
                }
                replyText.value = sanitizeReplyHtml(replyEditor.innerHTML.trim());
            }

            function extractPlainText(html) {
                if (!html) return '';
                const temp = document.createElement('div');
                temp.innerHTML = html;
                return (temp.textContent || '').replace(/\s+/g, ' ').trim();
            }

            function sanitizeReplyHtml(rawHtml) {
                return sanitizeMessageHtml(rawHtml);
            }
            
            // Загружаем хедер и футер
            loadHeaderAndFooter();
        });
        
        // Функция загрузки хедера и футера
        function loadHeaderAndFooter() {
            // Загружаем хедер
            fetch('/fragments/header.html')
                .then(response => {
                    if (!response.ok) throw new Error('Не удалось загрузить хедер');
                    return response.text();
                })
                .then(html => {
                    document.getElementById('header').innerHTML = html;
                    console.log('Хедер загружен в обсуждении');
                    if (typeof initializeHeader === 'function') {
                        initializeHeader();
                    }
                })
                .catch(error => {
                    console.error('Ошибка загрузки хедера:', error);
                    document.getElementById('header').innerHTML = '<div style="color: white; padding: 20px; text-align: center;">Ошибка загрузки хедера</div>';
                });
            
            // Загружаем футер
            fetch('/fragments/footer.html')
                .then(response => {
                    if (!response.ok) throw new Error('Не удалось загрузить футер');
                    return response.text();
                })
                .then(html => {
                    document.getElementById('footer').innerHTML = html;
                    if (typeof initializeFooter === 'function') {
                        initializeFooter();
                    }
                })
                .catch(error => {
                    console.error('Ошибка загрузки футера:', error);
                    document.getElementById('footer').innerHTML = '<div style="color: white; padding: 20px; text-align: center;">Ошибка загрузки футера</div>';
                });
        }
    </script>
</body>
</html>

